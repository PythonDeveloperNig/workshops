{%- assign files = step.vars.dir | append: '/partials' | listFiles %}
{%- for file in files %}
{% assign filePath = step.vars.dir | append: '/partials/' | append: file %}
# Rendered from {{ filePath }}
cat <<EOF >/root/files/{{ file | remove: ".liquid" }}
{{ filePath | render: step: step }}
EOF
{%- endfor %}

{%- assign files = step.vars.dir | append: '/data' | listFiles %}
{%- for file in files %}
{% assign filePath = step.vars.dir | append: '/data/' | append: file %}
# Rendered from {{ filePath }}
mkdir -p /root/data/steps/{{ step.name }}/
cat <<EOF >/root/data/steps/{{ step.name }}/{{ file }}
{{ filePath | raw_include }}
EOF
{%- endfor %}

{%- for subStep in step.vars.subStepList %}
{%- for s in steps %}
{%- if subStep == s.name %}

{%- assign files = s.vars.dir | append: '/data' | listFiles %}
{%- for file in files %}
{% assign filePath = s.vars.dir | append: '/data/' | append: file %}
# Rendered from {{ filePath }}
mkdir -p /root/data/steps/{{ s.name }}/
cat <<EOF >/root/data/steps/{{ s.name }}/{{ file }}
{{ filePath | raw_include }}
EOF
{%- endfor %}

// Should we render partials in files ?
{%- assign files = s.vars.dir | append: '/partials' | listFiles %}
{%- for file in files %}
{% assign filePath = s.vars.dir | append: '/partials/' | append: file %}
# Rendered from {{ filePath }}
cat <<EOF >/root/files/{{ file | remove: ".liquid" }}
{{ filePath | render: step: s }}
EOF
{%- endfor %}

{%- endif %}
{%- endfor %}
{%- endfor %}