
#!/bin/bash

# Enable bash completion for kubectl
echo "source /usr/share/bash-completion/bash_completion" >> /etc/bash.bashrc
echo "complete -F __start_kubectl k" >> /etc/bash.bashrc

while [ ! -f /opt/instruqt/bootstrap/host-bootstrap-completed ]
do
    echo "Waiting for Instruqt to finish booting the VM"
    sleep 1
done

mkdir -p /root/files

# Speed up dns resolution
for hostentry in raw.githubusercontent.com storage.googleapis.com run.solo.io github.com api.github.com istio.io
do
  echo "$(dig +short $hostentry @8.8.8.8|tr '\n' ' ') $hostentry" >> /etc/hosts
done
echo "options single-request" >> /etc/resolv.conf

while ! stat /etc/rancher/k3s/k3s.yaml; do sleep 1; done

export LOCAL_IP=$(dig +short $(hostname).$INSTRUQT_PARTICIPANT_ID.svc.cluster.local | grep -v '\.$')
cat /etc/rancher/k3s/k3s.yaml | sed 's/127.0.0.1/$LOCAL_IP/' | sed 's/default/$HOSTNAME/' | HOSTNAME=$(hostname) envsubst > /tmp/$HOSTNAME
while ! rsync -e "ssh -o StrictHostKeyChecking=no" -v /tmp/$HOSTNAME mgmt.$INSTRUQT_PARTICIPANT_ID.svc.cluster.local:/root/.kube/$HOSTNAME; do sleep 1; done

touch /root/.env
echo "export MGMT=mgmt" >> /root/.env
echo "export CLUSTER1=cluster1" >> /root/.env
echo "export CLUSTER2=cluster2" >> /root/.env